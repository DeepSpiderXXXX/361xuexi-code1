# -*- coding: utf-8 -*-
"""
Created on Wed Jan 31 14:51:28 2018

@author: 陈才
"""


import numpy as np # linear algebra
import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)
from nltk.corpus import stopwords
import string
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.model_selection import train_test_split
import gc
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn import *

# Input data files are available in the "../input/" directory.
# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory

from subprocess import check_output

train = pd.read_csv('data/train_first.csv')
test = pd.read_csv('data/predict_first.csv')

#train['Score'] = train['Score'].apply(lambda x:x-1)
train['Score'] = train['Score']

train = train.fillna("unknown")
test = test.fillna("unknown")

import jieba  
import jieba.posseg as pseg  

#将句子进行分词处理，并用空格隔开
def splitword(dicuss):  
    seg_list = jieba.cut(dicuss)
    return ' '.join(seg_list)

#设置每个分数的样本在训练的时候的权重
def getweight(score):
    if score == 1 :
        return 10
    if score == 2 :
        return 5
    if score == 3:
        return 2 
    if score == 4:
        return 1
    if score == 5:
        return 1
    return 0

# 去除所有非中文的字符
train.Discuss = train.Discuss.replace('[^\u4e00-\u9fa5]','',regex=True)

#进行分词处理
train['splitword'] = train['Discuss'].apply(lambda x:splitword(x)) 
#获取评论的长度
train['wordlength'] = train['Discuss'].apply(lambda x:len(x)) 
train['weight'] = train['Score'].apply(lambda x:getweight(x)) 

#对分数进行归一化处理
train['Score'] = train['Score'] / 5

test.Discuss = test.Discuss.replace('[^\u4e00-\u9fa5]','',regex=True)

test['splitword'] = test['Discuss'].apply(lambda x:splitword(x))
test['wordlength'] = test['Discuss'].apply(lambda x:len(x))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        


X_train = train['splitword']
y_train = train['Score']
X_test = test['splitword']


from keras.preprocessing import sequence
from keras.models import Model, Input
from keras.layers import Dense, SpatialDropout1D, Dropout
from keras.layers import Embedding, GlobalMaxPool1D, BatchNormalization
from keras.preprocessing.text import Tokenizer
from keras import optimizers
from keras.models import Model
from keras import regularizers
from keras.layers import Dense, Embedding, Input
from keras.layers import LSTM, Bidirectional, GlobalMaxPool1D, GlobalMaxPooling1D,Dropout,Conv1D,MaxPooling1D,Flatten
from keras.preprocessing import text, sequence
from keras.callbacks import EarlyStopping, ModelCheckpoint
from keras.preprocessing import text, sequence
from keras.models import Sequential
from keras.layers import Dense, Dropout, Activation
from keras.layers import Embedding
from keras.layers import Conv1D, GlobalMaxPooling1D
from sklearn.model_selection import train_test_split
import numpy as np
import pandas as pd
from keras.models import Model
from keras.layers import Dense, Embedding, Input
from keras.layers import GRU, Dropout, MaxPooling1D, Conv1D
from keras.preprocessing import text, sequence
from keras.callbacks import EarlyStopping, ModelCheckpoint


max_features = 50000
max_text_length = 150
embedding_dims = 64
filters = 250
kernel_size = 5
hidden_dims = 250
batch_size = 32
epochs = 8


print('Tokenizing data...')
tok = Tokenizer(num_words=max_features)
tok.fit_on_texts(list(X_train) + list(X_test))
x_train = tok.texts_to_sequences(X_train)
x_test = tok.texts_to_sequences(X_test)
print(len(x_train), 'train sequences')
print(len(x_test), 'test sequences')
print('Average train sequence length: {}'.format(np.mean(list(map(len, x_train)), dtype=int)))
print('Average test sequence length: {}'.format(np.mean(list(map(len, x_test)), dtype=int)))

print('Pad sequences (samples x time)')
x_train = sequence.pad_sequences(x_train, maxlen=max_text_length)
x_test = sequence.pad_sequences(x_test, maxlen=max_text_length)
print('x_train shape:', x_train.shape)
print('x_test shape:', x_test.shape)


x_validate = x_train[-10000:]
x_train = x_train[:-10000]
y_validate = y_train[-10000:]
y_train = y_train[:-10000]


print('Build model...')
inp = Input(shape=(max_text_length, ))
main = Embedding(max_features, embedding_dims)(inp)
main = Conv1D(filters=32, kernel_size=3, padding='same', activation='relu')(main)
main = MaxPooling1D(pool_size=2)(main)
main = Dropout(0.2)(main)
main = Conv1D(filters=32, kernel_size=3, padding='same', activation='relu')(main)
main = MaxPooling1D(pool_size=2)(main)
main = Dropout(0.2)(main)
main = Bidirectional(GRU(32))(main)
main = Dense(units=1,activation='linear')(main)

adam = optimizers.Adam(lr=0.001, beta_1=0.9, beta_2=0.999, epsilon=1e-08, decay=0.0)
model = Model(inputs=inp, outputs=main)
model.compile(loss='mse', optimizer=adam, metrics=['mse'])
model.summary()     

sample_weight=np.array(train['weight'])

early_stopping = EarlyStopping(monitor="val_loss", mode="min", patience=2)

callbacks_list = [early_stopping]

hist = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, validation_split=0.1,shuffle = True,callbacks=callbacks_list)


#计算模型的得分
def precision(test_y,predict_y):
    rmse = np.sqrt(np.mean((np.array(test_y).reshape(-1)-np.array(predict_y).reshape(-1))**2))
    print(rmse)
    return 1/(1+rmse)



y_pred = model.predict(x_validate)
print('validate:'+str(precision(y_pred*5,y_validate*5)))


y_pred = model.predict(x_test)

submid = pd.DataFrame({'Id': test["Id"],'Score':y_pred.reshape(-1),'Discuss':test['Discuss']})
submid['Score'] = submid['Score'] *5


def formatSocre(x):
    if x>5:
        return 5
    if x<1:
        return 1
    return x

submid['Score'] = submid['Score'].apply(lambda x:formatSocre(x))


import time
import datetime

t = time.time()

print('fasttext-'+str(int(t))+'.csv')
#submid.Score = submid.Score.apply(lambda x : x+1)
submission = submid
submission.to_csv('fasttext-'+str(int(t))+'.csv', index=False,header=False,columns=['Id','Score'])
     
lowscore = submission[submission.Score<2]

